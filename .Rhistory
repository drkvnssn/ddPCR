return(result)
}
ddpcr.analysis <- function(path,probe.path)
{
# - [x] start global analysis for experiment
exp.design <- read.design.file(path=path,pattern="design")
data.xy.max <-
combine.samples(path=path,files=exp.design$File) %>%
get.max.channels(.)
# - [x] analyze control files
control.data <-
exp.design[exp.design$Type == "pos" | exp.design$Type == "neg",2] %>%
combine.samples(path=path,files=.)
breakpoints <-
control.data %>%
get.ddpcr.breakpoints(., algorithm = "hist")
control.data %<>%
define.clusters(., breakpoints)
col.vec <-
control.data$Cluster %>%
define.color(., density=60)
# - [x] add probe data
# all.probe.data <- add.probe.data.v2(path = probe.path, name = exp.design[1,4], date = format(Sys.time(), "%Y-%m-%d"), breakpoints = breakpoints)
# - [x] get text for plotting
droplet.count <-
control.data$Cluster %>%
dropletcount.clusters(.)
# - [x] set file name control sample
control.name <- paste(strsplit(x = as.character(exp.design$File[1]),split = "_")[[1]][1],"_Controls",sep="")
output.file <- file.path(project.path, paste(control.name,".png",sep=""))
# - [x] create plot for control data
png(filename=output.file,width = 800,height = 800)
plot.ddpcr(x=control.data, main=control.name, max.xy=data.xy.max, breakpoints=breakpoints)
dev.off()
# - [x] retrieve sample files (all files)
sample.files <- exp.design[,2]
# - [ ] analyse sample files
for(i in 1:length(sample.files))
{
sample.data <-
read.table(file=file.path(path,sample.files[i]),header = TRUE,sep = ",") %>%
define.clusters(., breakpoints)
col.vec <-
sample.data$Cluster %>%
define.color(., density=60)
droplet.count <-
sample.data$Cluster %>%
dropletcount.clusters(.)
sample.name <- gsub(pattern = "_Amplitude.csv",replacement="",x=sample.files[i])
output.file <- file.path(project.path, paste(sample.name,".png",sep=""))
png(filename=output.file,width = 800,height = 800)
plot.ddpcr(x=sample.data, main=sample.name, max.xy = data.xy.max, breakpoints = breakpoints)
plot.cutoff(mean.4sd.cutoff(sample.data))
dev.off()
}
}
project.path <- "/Users/dirkvanessen/Desktop/ddPCR analysis/input.data/L858R"
ddpcr.analysis(path = project.path, probe.path = probe.path)
ddpcr.analysis <- function(path,probe.path)
{
# - [x] start global analysis for experiment
exp.design <- read.design.file(path=path,pattern="design")
data.xy.max <-
combine.samples(path=path,files=exp.design$File) %>%
get.max.channels(.)
# - [x] analyze control files
control.data <-
exp.design[exp.design$Type == "pos" | exp.design$Type == "neg",2] %>%
combine.samples(path=path,files=.)
breakpoints <-
control.data %>%
get.ddpcr.breakpoints(., algorithm = "hist")
control.data %<>%
define.clusters(., breakpoints)
col.vec <-
control.data$Cluster %>%
define.color(., density=60)
# - [x] add probe data
# all.probe.data <- add.probe.data.v2(path = probe.path, name = exp.design[1,4], date = format(Sys.time(), "%Y-%m-%d"), breakpoints = breakpoints)
# - [x] get text for plotting
droplet.count <-
control.data$Cluster %>%
dropletcount.clusters(.)
# - [x] set file name control sample
control.name <- paste(strsplit(x = as.character(exp.design$File[1]),split = "_")[[1]][1],"_Controls",sep="")
output.file <- file.path(project.path, paste(control.name,".png",sep=""))
# - [x] create plot for control data
png(filename=output.file,width = 800,height = 800)
plot.ddpcr(x=control.data, main=control.name, max.xy=data.xy.max, breakpoints=breakpoints)
dev.off()
# - [x] retrieve sample files (all files)
sample.files <- exp.design[,2]
# - [ ] analyse sample files
for(i in 1:length(sample.files))
{
sample.data <-
read.table(file=file.path(path,sample.files[i]),header = TRUE,sep = ",") %>%
define.clusters(., breakpoints)
col.vec <-
sample.data$Cluster %>%
define.color(., density=60)
droplet.count <-
sample.data$Cluster %>%
dropletcount.clusters(.)
sample.name <- gsub(pattern = "_Amplitude.csv",replacement="",x=sample.files[i])
output.file <- file.path(project.path, paste(sample.name,".png",sep=""))
png(filename=output.file,width = 800,height = 800)
plot.ddpcr(x=sample.data, main=sample.name, max.xy = data.xy.max, breakpoints = breakpoints)
plot.cutoffs(mean.4sd.cutoff(sample.data))
dev.off()
}
}
project.path <- "/Users/dirkvanessen/Desktop/ddPCR analysis/input.data/L858R"
ddpcr.analysis(path = project.path, probe.path = probe.path)
input.path <- "/Users/dirkvanessen/Desktop/ddPCR analysis" # home
folders <- c("archive","input.data","output.data","output.plot","scripts","scripts.log")
project.path <- "/Users/dirkvanessen/Desktop/ddPCR analysis/input.data/L858R"
ddpcr.analysis(path = project.path, probe.path = probe.path)
mean.cluster <- function(x,cluster=1)
{
x %<>%
data.frame(.) %>%
filter(.,Cluster == cluster) %>%
cluster.mean.sd(.)
return(x)
}
ddpcr.analysis(path = project.path, probe.path = probe.path)
project.path <- "/Users/dirkvanessen/Desktop/ddPCR analysis/input.data/E746_A750del"
ddpcr.analysis(path = project.path, probe.path = probe.path)
project.path <- "/Users/dirkvanessen/Desktop/ddPCR analysis/input.data/T790M"
ddpcr.analysis(path = project.path, probe.path = probe.path)
project.path <- "/Users/dirkvanessen/Desktop/ddPCR analysis/input.data/test"
ddpcr.analysis(path = project.path, probe.path = probe.path)
project.path -> path
exp.design <- read.design.file(path=path,pattern="design")
data.xy.max <-
combine.samples(path=path,files=exp.design$File) %>%
get.max.channels(.)
# - [x] analyze control files
control.data <-
exp.design[exp.design$Type == "pos" | exp.design$Type == "neg",2] %>%
combine.samples(path=path,files=.)
control.data -> x
sum(x$Cluster == 2) == 0
cluster.1 <- mean.cluster(x, cluster=1)
cluster.1
mean.cluster <- function(x,cluster=1, zero=TRUE)
{
if(zero == TRUE)
{
x <- c(0,0);cluster <- rbind(cluster,c(0,0))
} else
{
x %<>%
data.frame(.) %>%
filter(.,Cluster == cluster) %>%
cluster.mean.sd(.)
}
return(x)
}
mean.cluster(x, cluster=2, zero=TRUE)
mean.cluster <- function(x,cluster=1, zero=TRUE)
{
if(zero == TRUE)
{
x <- c(0,0);
x <- rbind(x,c(0,0))
} else
{
x %<>%
data.frame(.) %>%
filter(.,Cluster == cluster) %>%
cluster.mean.sd(.)
}
return(x)
}
mean.cluster(x, cluster=2, zero=TRUE)
cluster.1
mean.cluster <- function(x,cluster=1, zero=TRUE)
{
if(zero == TRUE)
{
x <- c(0,0);
x <- rbind(x,c(0,0))
colnames(cluster)<- c("Ch1","Ch2")
rownames(cluster) <- c("mean","sd")
} else
{
x %<>%
data.frame(.) %>%
filter(.,Cluster == cluster) %>%
cluster.mean.sd(.)
}
return(x)
}
mean.cluster(x, cluster=2, zero=TRUE)
mean.cluster <- function(x,cluster=1, zero=TRUE)
{
if(zero == TRUE)
{
x <- c(0,0);
x <- rbind(x,c(0,0))
colnames(x)<- c("Ch1","Ch2")
rownames(x) <- c("mean","sd")
} else
{
x %<>%
data.frame(.) %>%
filter(.,Cluster == cluster) %>%
cluster.mean.sd(.)
}
return(x)
}
mean.cluster <- function(x,cluster=1, zero=TRUE)
{
if(zero == TRUE)
{
x <- c(0,0);
x <- rbind(x,c(0,0))
colnames(x)<- c("Ch1","Ch2")
rownames(x) <- c("mean","sd")
} else
{
x %<>%
data.frame(.) %>%
filter(.,Cluster == cluster) %>%
cluster.mean.sd(.)
}
return(x)
}
mean.cluster(x, cluster=2, zero=TRUE)
define.clusters <- function(x, breakpoints)
{
if (length(breakpoints) != 2) {
stop("breakpoints must have a length of 2.\n")
}
# - [x] find cluster notation BioRad
results <- rep(NA,dim(x)[1])
results[x[,1] < breakpoints[1] & x[,2] < breakpoints[2]] <- 1 # ch1-ch2- : cluster 1
results[x[,1] > breakpoints[1] & x[,2] < breakpoints[2]] <- 2 # ch1+ch2- : cluster 2
results[x[,1] > breakpoints[1] & x[,2] > breakpoints[2]] <- 3 # ch1+ch2+ : cluster 3
results[x[,1] < breakpoints[1] & x[,2] > breakpoints[2]] <- 4 # ch1-ch2+ : cluster 4
x[,3] <- results
return(x)
}
define.color <- function(x,density=40)
{
# - [x] find cluster notation BioRad
ddpcr.colors <- paste(c("#000000","#FF6600","#00CC00","#0033FF"), as.character(density), sep="")
x <- as.character(x)
x <- mgsub(pattern = c("1","3","4","2"),replacement = ddpcr.colors,x=x)
return(x)
}
dropletcount.clusters <- function(x)
{
results <- NULL
results <- list(clusters=c(cluster.1=sum(x == 1),cluster.2=sum(x == 2),cluster.3=sum(x == 3),cluster.4=sum(x == 4)))
results  <-paste("Ch1-Ch2-:",results$clusters[1],
"   Ch1+Ch2-:",results$clusters[2],
"   Ch1+Ch2+:",results$clusters[3],
"   Ch1-Ch2+:",results$clusters[4], sep="")
return(results)
}
get.max.channels <- function(x)
{
results <- c(Ch1.max = round(max(x[,1])+100) ,Ch2.max = round(max(x[,2])+100))
return(results)
}
plot.ddpcr <- function(x,dotres=0.7,main="ddPCR",pch=16,colors="ddpcr",density=60,breakpoints=NULL,max.xy=NULL,verbose=FALSE)
{
if(length(max.xy) != 2) {
xmax <- max(x[,2])
ymax <- max(x[,1])
} else {
xmax <- max.xy[2]
ymax <- max.xy[1]
}
col.vec <- define.color(x = x[,3],density = density)
plot(y=x[,1],x=x[,2], cex=dotres, col=col.vec, ylab="Ch1 Amplitude",xlab="Ch2 Amplitude", pch=pch, main=main,
xlim=c(0,xmax),ylim=c(0,ymax))
sub.text <- dropletcount.clusters(x=x[,3])
mtext(side = 3,text = sub.text, cex = 0.8)
if (length(breakpoints) != 2) {
if(verbose == TRUE){cat("No breakpoint data has been given. Data will not be plotted.")}
}else{
abline(h=breakpoints[1], col="red") # channel 1
abline(v=breakpoints[2], col="red") # channel 2
}
}
plot.cutoffs <- function(x,col="black")
{
abline(h=x[1], col=col)
abline(v=x[2], col=col)
}
mean.cluster <- function(x,cluster=1, zero=TRUE)
{
if(zero == TRUE)
{
x <- c(0,0);
x <- rbind(x,c(0,0))
colnames(x)<- c("Ch1","Ch2")
rownames(x) <- c("mean","sd")
} else
{
x %<>%
data.frame(.) %>%
filter(.,Cluster == cluster) %>%
cluster.mean.sd(.)
}
return(x)
}
cluster.mean.sd <- function(x)
{
cluster <- c(mean(x[,1]), mean(x[,2]))
cluster <- rbind(cluster,c(sd(x[,1]), sd(x[,2])))
colnames(cluster)<- c("Ch1","Ch2")
rownames(cluster) <- c("mean","sd")
return(cluster)
}
mean.4sd.cutoff <- function(x)
{ # mean of the clusters + 4 times the sd of the cluster
cluster.1 <- mean.cluster(x, cluster=1)
if(sum(x$Cluster == 2) > 0)
{
cluster.2 <- mean.cluster(x, cluster=2, zero=TRUE)
} else
{
cluster.2 <- mean.cluster(x, cluster=2)
}
if(sum(x$Cluster == 4) > 0)
{
cluster.4 <- mean.cluster(x, cluster=4, zero=TRUE)
} else
{
cluster.4 <- mean.cluster(x, cluster=4)
}
channel.1 <- max(cluster.1[1,1]+(cluster.1[2,1]*4),cluster.4[1,1]+(cluster.4[2,1]*4))
channel.2 <- max(cluster.1[1,2]+(cluster.1[2,2]*4),cluster.2[1,2]+(cluster.2[2,2]*4))
result <- c(Ch1=channel.1,Ch2=channel.2)
return(result)
}
ddpcr.an
ddpcr.analysis <- function(path,probe.path)
{
# - [x] start global analysis for experiment
exp.design <- read.design.file(path=path,pattern="design")
data.xy.max <-
combine.samples(path=path,files=exp.design$File) %>%
get.max.channels(.)
# - [x] analyze control files
control.data <-
exp.design[exp.design$Type == "pos" | exp.design$Type == "neg",2] %>%
combine.samples(path=path,files=.)
breakpoints <-
control.data %>%
get.ddpcr.breakpoints(., algorithm = "hist")
control.data %<>%
define.clusters(., breakpoints)
col.vec <-
control.data$Cluster %>%
define.color(., density=60)
# - [x] add probe data
# all.probe.data <- add.probe.data.v2(path = probe.path, name = exp.design[1,4], date = format(Sys.time(), "%Y-%m-%d"), breakpoints = breakpoints)
# - [x] get text for plotting
droplet.count <-
control.data$Cluster %>%
dropletcount.clusters(.)
# - [x] set file name control sample
control.name <- paste(strsplit(x = as.character(exp.design$File[1]),split = "_")[[1]][1],"_Controls",sep="")
output.file <- file.path(project.path, paste(control.name,".png",sep=""))
# - [x] create plot for control data
png(filename=output.file,width = 800,height = 800)
plot.ddpcr(x=control.data, main=control.name, max.xy=data.xy.max, breakpoints=breakpoints)
dev.off()
# - [x] retrieve sample files (all files)
sample.files <- exp.design[,2]
# - [ ] analyse sample files
for(i in 1:length(sample.files))
{
sample.data <-
read.table(file=file.path(path,sample.files[i]),header = TRUE,sep = ",") %>%
define.clusters(., breakpoints)
col.vec <-
sample.data$Cluster %>%
define.color(., density=60)
droplet.count <-
sample.data$Cluster %>%
dropletcount.clusters(.)
sample.name <- gsub(pattern = "_Amplitude.csv",replacement="",x=sample.files[i])
output.file <- file.path(project.path, paste(sample.name,".png",sep=""))
png(filename=output.file,width = 800,height = 800)
plot.ddpcr(x=sample.data, main=sample.name, max.xy = data.xy.max, breakpoints = breakpoints)
plot.cutoffs(mean.4sd.cutoff(sample.data))
dev.off()
}
}
project.path <- "/Users/dirkvanessen/Desktop/ddPCR analysis/input.data/L858R"
ddpcr.analysis(path = project.path, probe.path = probe.path)
exp.design <- read.design.file(path=path,pattern="design")
data.xy.max <-
combine.samples(path=path,files=exp.design$File) %>%
get.max.channels(.)
# - [x] analyze control files
control.data <-
exp.design[exp.design$Type == "pos" | exp.design$Type == "neg",2] %>%
combine.samples(path=path,files=.)
control.data -> x
breakpoints <-
control.data %>%
get.ddpcr.breakpoints(., algorithm = "hist")
control.data %<>%
define.clusters(., breakpoints)
col.vec <-
control.data$Cluster %>%
define.color(., density=60)
x <- control.data
sum(x$Cluster == 2
)
sum(x$Cluster == 5)
mean.4sd.cutoff <- function(x)
{ # mean of the clusters + 4 times the sd of the cluster
cluster.1 <- mean.cluster(x, cluster=1)
if(sum(x$Cluster == 2) = 0)
{
cluster.2 <- mean.cluster(x, cluster=2, zero=TRUE)
} else
{
cluster.2 <- mean.cluster(x, cluster=2)
}
if(sum(x$Cluster == 4) = 0)
{
cluster.4 <- mean.cluster(x, cluster=4, zero=TRUE)
} else
{
cluster.4 <- mean.cluster(x, cluster=4)
}
channel.1 <- max(cluster.1[1,1]+(cluster.1[2,1]*4),cluster.4[1,1]+(cluster.4[2,1]*4))
channel.2 <- max(cluster.1[1,2]+(cluster.1[2,2]*4),cluster.2[1,2]+(cluster.2[2,2]*4))
result <- c(Ch1=channel.1,Ch2=channel.2)
return(result)
}
mean.4sd.cutoff <- function(x)
{ # mean of the clusters + 4 times the sd of the cluster
cluster.1 <- mean.cluster(x, cluster=1)
if(sum(x$Cluster == 2) = 0)
{
cluster.2 <- mean.cluster(x, cluster=2, zero=TRUE)
} else
{
cluster.2 <- mean.cluster(x, cluster=2)
}
if(sum(x$Cluster == 4) = 0)
{
cluster.4 <- mean.cluster(x, cluster=4, zero=TRUE)
} else
{
cluster.4 <- mean.cluster(x, cluster=4)
}
channel.1 <- max(cluster.1[1,1]+(cluster.1[2,1]*4),cluster.4[1,1]+(cluster.4[2,1]*4))
channel.2 <- max(cluster.1[1,2]+(cluster.1[2,2]*4),cluster.2[1,2]+(cluster.2[2,2]*4))
result <- c(Ch1=channel.1,Ch2=channel.2)
return(result)
}
mean.4sd.cutoff <- function(x)
{ # mean of the clusters + 4 times the sd of the cluster
cluster.1 <- mean.cluster(x, cluster=1)
if(sum(x$Cluster == 2) == 0)
{
cluster.2 <- mean.cluster(x, cluster=2, zero=TRUE)
} else
{
cluster.2 <- mean.cluster(x, cluster=2)
}
if(sum(x$Cluster == 4) == 0)
{
cluster.4 <- mean.cluster(x, cluster=4, zero=TRUE)
} else
{
cluster.4 <- mean.cluster(x, cluster=4)
}
channel.1 <- max(cluster.1[1,1]+(cluster.1[2,1]*4),cluster.4[1,1]+(cluster.4[2,1]*4))
channel.2 <- max(cluster.1[1,2]+(cluster.1[2,2]*4),cluster.2[1,2]+(cluster.2[2,2]*4))
result <- c(Ch1=channel.1,Ch2=channel.2)
return(result)
}
ddpcr.analysis(path = project.path, probe.path = probe.path)
cluster.1 <- mean.cluster(x, cluster=1)
cluster.1
mean.cluster <- function(x,cluster=1, zero=FALSE)
{
if(zero == TRUE)
{
x <- c(0,0);
x <- rbind(x,c(0,0))
colnames(x)<- c("Ch1","Ch2")
rownames(x) <- c("mean","sd")
} else
{
x %<>%
data.frame(.) %>%
filter(.,Cluster == cluster) %>%
cluster.mean.sd(.)
}
return(x)
}
ddpcr.analysis(path = project.path, probe.path = probe.path)
project.path <- "/Users/dirkvanessen/Desktop/ddPCR analysis/input.data/E746_A750del"
ddpcr.analysis(path = project.path, probe.path = probe.path)
project.path <- "/Users/dirkvanessen/Desktop/ddPCR analysis/input.data/T790M"
ddpcr.analysis(path = project.path, probe.path = probe.path)
project.path <- "/Users/dirkvanessen/Desktop/ddPCR analysis/input.data/test"
ddpcr.analysis(path = project.path, probe.path = probe.path)
